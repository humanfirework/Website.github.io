<% if (page.type == 404) { %>
  <%- partial('404', {post: page}) %>
<% } else { %>
  <!DOCTYPE html>
  <html <% if (page.lang) { %>lang="<%- page.lang %>" <% } else if (config.language) { %>lang="<%- config.language %>" <% } %> 
    <% if (theme.dark_mode.enable === true) { %>
      data-theme-mode="true"
    <% } else if (theme.dark_mode.enable === 'auto') { %>
      data-theme-mode="auto"
    <% } else if (theme.dark_mode.enable === false) { %>
      data-theme-mode="false"
    <% } %>
  >
  <%- partial('_partial/head', {post: page}) %>
  <body>
    <!-- Dynamic Wallpaper -->
    <img src="<%- url_for('/images/风.png') %>" class="bg-video bg-video-day" alt="Day Wallpaper">
    <img src="<%- url_for('/images/草地.png') %>" class="bg-video bg-video-night" alt="Night Wallpaper">
    <div class="bg-mask"></div>
    <style>
      .bg-video {
        position: fixed;
        z-index: -2;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100vw;
        height: 100vh;
        object-fit: cover;
        pointer-events: none;
        transition: opacity 1s ease;
      }
      .bg-mask {
        position: fixed;
        z-index: -1;
        left: 0;
        right: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.2); /* Clear mask for contrast */
        pointer-events: none;
      }
      .bg-video.bg-video-day { opacity: 1; }
      .bg-video.bg-video-night { opacity: 0; }
      
      /* Night mode support for Reimu theme */
      html[data-theme="dark"] .bg-video.bg-video-day { opacity: 0; }
      html[data-theme="dark"] .bg-video.bg-video-night { opacity: 1; }
      /* Darker mask in night mode */
      html[data-theme="dark"] .bg-mask { background: rgba(0, 0, 0, 0.5); }

      /* Transparent backgrounds to show wallpaper */
      #wrap, body {
        background: transparent !important;
      }
      /* If banner has background, make it transparent too */
      #banner, #banner .shape {
        background: transparent !important;
      }
      /* Additional transparency settings from user reference */
      #header, #header-outer { 
        background: transparent !important; 
      }
      #header img, #header picture, .icon-taichi { 
        display: none !important; 
      }
    </style>
    <% if (theme.injector.body_begin) { %>
      <%- render(theme.injector.body_begin, 'html'); %>
    <% } %>
    <%- partial('_partial/loader', {post: page}) %>
    <div id="container">
      <div id="wrap">
        <%- partial('_partial/header', {post: page}) %>
        <div id="content" <% if (page.sidebar === 'left' || page.sidebar === undefined && theme.sidebar === 'left') { %>class="sidebar-left" <% } %> <% if (page.sidebar === 'right' || page.sidebar === undefined && theme.sidebar === 'right') { %>class="sidebar-right" <% } %>>
          <%- partial('_partial/sidebar', { post: page }) %>
          <section id="main"><%- body %></section>
        </div>
        <%- partial_lang('_partial/footer', null, { cache: !config.relative_link, lang: page.lang }) %>
        <% if (theme.top.enable) { %>
          <div class="sidebar-top">
            <div class="sidebar-top-taichi <%- theme.top.icon?.rotate ? 'rotate' : '' %>"></div>
            <div class="arrow-up"></div>
          </div>
        <% } %>
        <div id="mask" class="hide"></div>
      </div>
      <%- partial('_partial/mobile-nav', { post: page }) %>
    </div>
    <% if (theme.algolia_search.enable || theme.generator_search.enable) { %>
      <div class="site-search">
        <div class="reimu-popup popup">
          <div class="reimu-search">
            <div class="reimu-search-input-icon"></div>
            <div class="reimu-search-input" id="reimu-search-input"></div>
            <div class="popup-btn-close"></div>
          </div>
          <div class="reimu-results">
            <div id="reimu-stats"></div>
            <div id="reimu-hits"></div>
            <div id="reimu-pagination" class="reimu-pagination"></div>
          </div>
          <img class="reimu-bg" src="<%- url_for('/images/taichi.png', {relative: false}) %>"/>
        </div>
      </div>
    <% } %>
    <% if (theme.player.aplayer.enable && !theme.player.meting.enable && theme.player.aplayer.options.fixed === true) { %>
      <div id="aplayer" theme="var(--color-link)"></div>
    <% } %>
    <% if (theme.player.meting.enable && theme.player.aplayer.options.fixed === true) { %>
      <meting-js
        theme="var(--color-link)"
        <% if (theme.player.meting.options.id != null) { %>id="<%= theme.player.meting.options.id %>"<% } %>
        <% if (theme.player.meting.options.server != null) { %>server="<%= theme.player.meting.options.server %>"<% } %>
        <% if (theme.player.meting.options.type != null) { %>type="<%= theme.player.meting.options.type %>"<% } %>
        <% if (theme.player.meting.options.auto != null) { %>auto="<%= theme.player.meting.options.auto %>"<% } %>
        <% if (theme.player.meting.options.fixed != null) { %>fixed="<%= theme.player.meting.options.fixed %>"<% } %>
        <% if (theme.player.meting.options.mini != null) { %>mini="<%= theme.player.meting.options.mini %>"<% } %>
        <% if (theme.player.meting.options.autoplay != null) { %>autoplay="<%= theme.player.meting.options.autoplay %>"<% } %>
        <% if (theme.player.meting.options.loop != null) { %>loop="<%= theme.player.meting.options.loop %>"<% } %>
        <% if (theme.player.meting.options.order != null) { %>order="<%= theme.player.meting.options.order %>"<% } %>
        <% if (theme.player.meting.options.preload != null) { %>preload="<%= theme.player.meting.options.preload %>"<% } %>
        <% if (theme.player.meting.options.volume != null) { %>volume="<%= theme.player.meting.options.volume %>"<% } %>
        <% if (theme.player.meting.options.mutex != null) { %>mutex="<%= theme.player.meting.options.mutex %>"<% } %>
        <% if (theme.player.meting.options.listFolded != null) { %>list-folded="<%= theme.player.meting.options.listFolded %>"<% } %>
        <% if (theme.player.meting.options.lrcType != null) { %>lrc-type="<%= theme.player.meting.options.lrcType %>"<% } %>
      ></meting-js>
    <% } %>
    <%- partial('_partial/after-footer', {post: page}) %>
    <% if (theme.injector.body_end) { %>
      <%- render(theme.injector.body_end, 'html'); %>
    <% } %>
    <% if (theme.player.aplayer.enable) { %>
      <% if (theme.player.meting.enable) { %>
        <div class="aplayer" 
          data-id="<%= theme.player.meting.options.id %>" 
          data-server="<%= theme.player.meting.options.server %>" 
          data-type="<%= theme.player.meting.options.type %>" 
          data-fixed="<%= theme.player.meting.options.fixed %>" 
          data-mini="<%= theme.player.meting.options.mini %>"
          data-order="<%= theme.player.meting.options.order %>"
          data-loop="<%= theme.player.meting.options.loop %>"
          data-preload="<%= theme.player.meting.options.preload %>"
          data-list-folded="<%= theme.player.meting.options.listFolded %>">
        </div>
      <% } else if (theme.player.aplayer.options.audio) { %>
        <div id="aplayer"></div>
      <% } %>
    <% } %>
  </body>
  </html>
<% } %>
