<% const commentSystems = {}; %>
<% commentSystems.valine = theme.valine.enable && theme.valine.appId && theme.valine.appKey ? true : false; %>
<% commentSystems.waline = theme.waline.enable && theme.waline.serverURL ? true : false; %>
<% commentSystems.twikoo = theme.twikoo.enable && theme.twikoo.envId ? true : false; %>
<% commentSystems.gitalk = theme.gitalk.enable && theme.gitalk.clientID && theme.gitalk.clientSecret ? true : false; %>
<% commentSystems.giscus = theme.giscus.enable ? true : false; %>
<% 
  const activeSystems = Object.keys(commentSystems).filter(system => commentSystems[system]); 
  const defaultSystem = theme.comment.default;
%>

<% if (activeSystems.length > 0) { %>
<script data-pjax>
  var loadScript = (src, integrity) => {
    const script = document.createElement('script');
    script.src = src;
    if (integrity) script.integrity = integrity;
    script.crossOrigin = 'anonymous';
    return script;
  };

  var commentConfigKeys = ['valine', 'waline', 'twikoo', 'gitalk', 'giscus'];
  var commentConfig = {
    valine: {
      enable: <%= commentSystems.valine %>,
      load: () => {
        const container = document.querySelector('.valine-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          '<%= vendorCdn(theme.vendor.js.valine)[0] %>',
          '<%= vendorCdnIntegrity(theme.vendor.js.valine)[0] %>'
        );
        script.onload = () => {
          var GUEST_INFO = ['nick', 'mail', 'link'];
          var guest_info = '<%= theme.valine.guest_info %>'.split(',').filter((item) => {
            return GUEST_INFO.indexOf(item) > -1
          });
          var recordIP = JSON.parse('<%= theme.valine.recordIP %>');
          var highlight = JSON.parse('<%= theme.valine.highlight %>');
          var visitor = JSON.parse('<%= theme.valine.visitor %>');
          var serverURLs = <% if(theme.valine.serverURLs) { %>'<%= theme.valine.serverURLs %>'<% } else { %>undefined<% } %>;

          if (window.Valine) {
            new Valine({
              el: '.valine-comment',
              appId: "<%= theme.valine.appId %>",
              appKey: "<%= theme.valine.appKey %>",
              placeholder: "<%= theme.valine.placeholder %>",
              pageSize: '<%= theme.valine.pageSize %>',
              avatar: '<%= theme.valine.avatar %>',
              lang: document.documentElement.lang || 'en',
              recordIP: recordIP,
              highlight: highlight,
              visitor: visitor,
              requiredFields: guest_info,
              path: window.location.pathname,
              serverURLs
            });
          }
        };
        document.head.appendChild(script);
      }
    },
    waline: {
      enable: <%= commentSystems.waline %>,
      load: async () => {
        const container = document.querySelector('.waline-comment');
        if (!container) return;
        container.style.display = 'block';

        let walineInit;
        const walineCdn = '<%= vendorCdn(theme.vendor.js.waline)[0] %>';
        const walineIntegrity = '<%= vendorCdnIntegrity(theme.vendor.js.waline)[0] %>';

        const module = await safeImport(walineCdn, walineIntegrity);
        walineInit = module.init;

        window.walineInstance = walineInit({
          el: '.waline-comment',
          serverURL: '<%= theme.waline.serverURL %>',
          lang: document.documentElement.lang || 'en',
          locale: <%- JSON.stringify(theme.waline.locale || {}) %>,
          emoji: <%- JSON.stringify(theme.waline.emoji || []) %>,
          meta: <%- JSON.stringify(theme.waline.meta || []) %>,
          requiredMeta: <%-JSON.stringify(theme.waline.requiredMeta || []) %>,
          wordLimit: JSON.parse('<%= theme.waline.wordLimit || 0 %>'),
          comment: true,
          pageSize: JSON.parse('<%= theme.waline.pageSize || 10 %>'),
          dark: 'html[data-theme="dark"]',
          pageview: JSON.parse('<%= theme.waline.pageview || false %>'),
        });
      }
    },
    twikoo: {
      enable: <%= commentSystems.twikoo %>,
      load: () => {
        const container = document.querySelector('.twikoo-comment');
        if (!container) return;
        container.style.display = 'block';

        const initTwikoo = () => {
          if (window.twikoo) {
            twikoo.init({
              envId: '<%= theme.twikoo.envId %>',
              el: '.twikoo-comment',
              region: '<%= theme.twikoo.region %>',
              lang: document.documentElement.lang || 'en',
            });

            twikoo.getCommentsCount({
              envId: '<%= theme.twikoo.envId %>',
              region: '<%= theme.twikoo.region %>',
              urls: [
                '<%- url_for_lang(post.path, {relative: false}) %>'
              ],
              includeReply: false
            }).then((res) => {
              const countEl = document.querySelector('.twikoo-comment-count');
              if (countEl && res[0]) countEl.innerText = res[0].count;
            }).catch((err) => {
              console.error(err);
            });
          }
        };

        if (window.twikoo) {
          initTwikoo();
        } else {
          const script = loadScript(
            '<%= vendorCdn(theme.vendor.js.twikoo)[0] %>',
            '<%= vendorCdnIntegrity(theme.vendor.js.twikoo)[0] %>'
          );
          script.onload = initTwikoo;
          document.head.appendChild(script);
        }
      }
    },
    gitalk: {
      enable: <%= commentSystems.gitalk %>,
      load: () => {
        const container = document.querySelector('.gitalk-comment');
        if (!container) return;
        container.style.display = 'block';

        const script = loadScript(
          '<%= vendorCdn(theme.vendor.js.gitalk)[0] %>',
          '<%= vendorCdnIntegrity(theme.vendor.js.gitalk)[0] %>'
        );

        script.onload = () => {
          const initGitalk = () => {
            var gitalkId = <%= theme.gitalk.md5 ? 'window.md5 ? window.md5(location.pathname) : location.pathname' : 'location.pathname' %>;
            var gitalk = new Gitalk({
              clientID: '<%= theme.gitalk.clientID %>',
              clientSecret: '<%= theme.gitalk.clientSecret %>',
              repo: '<%= theme.gitalk.repo %>',
              owner: '<%= theme.gitalk.owner %>',
              admin: <%- JSON.stringify(theme.gitalk.admin) %>,
              id: gitalkId,
              distractionFreeMode: false,
              language: document.documentElement.lang || 'en',
            })
            gitalk.render('gitalk-comment');
          }

          if (<%= theme.gitalk.md5 %>) {
            const md5Script = loadScript(
              '<%= vendorCdn(theme.vendor.js.md5)[0] %>',
              '<%= vendorCdnIntegrity(theme.vendor.js.md5)[0] %>'
            );
            md5Script.onload = initGitalk;
            document.head.appendChild(md5Script);
          } else {
            initGitalk();
          }
        }
        document.head.appendChild(script);
      }
    },
    giscus: {
      enable: <%= commentSystems.giscus %>,
      load: () => {
        const container = document.querySelector('.giscus-comment');
        if (!container) return;
        container.style.display = 'block';

        const existingScript = container.querySelector('script[src*="giscus.app/client.js"]');
        if (existingScript) existingScript.remove();
        const existingFrame = document.querySelector('iframe.giscus-frame');
        if (existingFrame) existingFrame.remove();

        const giscusScript = document.createElement('script');
        const domMode = document.documentElement.getAttribute("data-theme");

        const docLang = document.documentElement.lang || 'en';
        const langBase = docLang.split('-')[0];
        const supportedLangs = ['ar', 'be', 'bg', 'ca', 'cs', 'da', 'de', 'en', 
        'eo', 'es', 'eu', 'fa', 'fr', 'gr', 'hbs', 'he', 'hu', 'id', 'it', 'ja', 
        'kh', 'ko', 'nl', 'pl', 'pt', 'ro', 'ru', 'th', 'tr', 'uk', 'uz', 'vi', 'zh-CN', 'zh-HK', 'zh-TW'];
        const giscusLang = supportedLangs.includes(docLang) ? docLang : supportedLangs.includes(langBase) ? langBase : 'en';

        giscusScript.src = 'https://giscus.app/client.js';
        giscusScript.setAttribute('data-repo', '<%= theme.giscus.repo %>');
        giscusScript.setAttribute('data-repo-id', '<%= theme.giscus.repoId %>');
        giscusScript.setAttribute('data-category', '<%= theme.giscus.category %>'); 
        giscusScript.setAttribute('data-category-id', '<%= theme.giscus.categoryId %>');
        giscusScript.setAttribute('data-mapping', '<%= theme.giscus.strict %>');
        giscusScript.setAttribute('data-strict', '<%= theme.giscus.strict %>');
        giscusScript.setAttribute('data-reactions-enabled', '<%= theme.giscus.reactionsEnabled %>');
        giscusScript.setAttribute('data-emit-metadata', '<%= theme.giscus.emitMetadata %>');
        giscusScript.setAttribute('data-input-position', '<%= theme.giscus.inputPosition %>');
        giscusScript.setAttribute('data-theme', domMode === 'dark' ? 'dark' : 'light');
        giscusScript.setAttribute('data-lang', giscusLang);
        giscusScript.setAttribute('crossorigin', 'anonymous');
        giscusScript.async = true;
        container.appendChild(giscusScript);
      }
    }
  };

  var loadComment = (system) => {
    // 优先使用手动选择的系统，如果没有手动选择，则使用配置中的默认系统
    const activeSystem = system || localStorage.getItem('active_comment_system') || '<%= theme.comment.default %>' || activeSystems[0];
    
    // 如果当前的 activeSystem 在配置中没有启用，则回退到第一个启用的系统
    let finalSystem = activeSystem;
    if (!commentConfig[finalSystem] || !commentConfig[finalSystem].enable) {
      finalSystem = activeSystems[0];
    }

    if (commentConfig[finalSystem] && commentConfig[finalSystem].enable) {
      commentConfigKeys.forEach(key => {
        const el = document.querySelector(`.${key}-comment`);
        if (el) el.style.display = 'none';
        const selector = document.querySelector(`.selector-item[data-selector="${key}"]`);
        if (selector) selector.classList.remove('active');
      });

      commentConfig[finalSystem].load();
      const activeSelector = document.querySelector(`.selector-item[data-selector="${finalSystem}"]`);
      if (activeSelector) activeSelector.classList.add('active');
      
      // 只有在手动切换时才存入 localStorage，或者如果是初始加载，确保存入的是当前有效的系统
      if (system) {
        localStorage.setItem('active_comment_system', finalSystem);
      }
    }
  };

  // 初始加载时，如果 localStorage 中的系统与配置中的默认系统不一致，且用户没有在本次会话中手动切换过，
  // 我们可以考虑优先遵循配置。为了简单起见，这里直接先按配置来。
  const initialSystem = '<%= theme.comment.default %>' || activeSystems[0];
  loadComment(initialSystem);

  document.querySelectorAll('.selector-item').forEach(item => {
    item.addEventListener('click', function() {
      const system = this.getAttribute('data-selector');
      loadComment(system);
    });
  });
</script>
<% } %>
